/**
 * NYT Puzzle Loader
 * 
 * Loads and parses NYT Sudoku puzzles from .sdk files in the nyt-scraper/sudoku directory.
 * 
 * SDK file format:
 * - Line 1: #S<source name> (e.g., "#SNew York Times")
 * - Line 2: #B<date in DD-MM-YYYY> (e.g., "#B13-05-2023")
 * - Lines 3-11: 9 lines of puzzle data, one row per line (. for empty cells, digits 1-9)
 */

/**
 * Parses a single .sdk file content
 * @param {string} content - Raw content of the .sdk file
 * @param {string} filename - Filename for metadata extraction
 * @returns {Object} Puzzle object with {id, group, digits, date, difficulty, source, filename}
 */
function parseSDKFile(content, filename) {
    const lines = content.split(/\r?\n/).filter(line => line.length > 0);
    
    if (lines.length < 11) {
        console.warn(`Invalid SDK file ${filename}: expected at least 11 lines, got ${lines.length}`);
        return null;
    }

    // Parse header lines
    const sourceLine = lines[0];
    const dateLine = lines[1];
    
    // Extract source (remove #S prefix)
    const source = sourceLine.startsWith('#S') ? sourceLine.substring(2) : '';
    
    // Extract date (remove #B prefix, convert DD-MM-YYYY to Date object)
    let date = null;
    if (dateLine.startsWith('#B')) {
        const dateStr = dateLine.substring(2);
        const [day, month, year] = dateStr.split('-').map(s => parseInt(s, 10));
        date = new Date(year, month - 1, day);
    }

    // Extract difficulty from filename (e.g., "nyt-hard-2023-05-13.sdk" => "hard")
    const filenameMatch = filename.match(/nyt-(\w+)-(\d{4}-\d{2}-\d{2})\.sdk$/);
    const difficulty = filenameMatch ? filenameMatch[1] : 'unknown';
    const dateFromFilename = filenameMatch ? filenameMatch[2] : filename.replace('.sdk', '');

    // Create unique puzzle ID: nyt:hard-2023-05-13
    // This ID is stable and can be used to track solve history across sessions
    const puzzleId = `nyt:${difficulty}-${dateFromFilename}`;

    // Parse puzzle data (lines 3-11)
    const puzzleLines = lines.slice(2, 11);
    
    // Convert 9 lines into 81-character string, replacing '.' with '0'
    const digits = puzzleLines
        .map(line => line.split('').map(char => char === '.' ? '0' : char).join(''))
        .join('');

    if (digits.length !== 81) {
        console.warn(`Invalid puzzle data in ${filename}: expected 81 characters, got ${digits.length}`);
        return null;
    }

    return {
        id: puzzleId,
        group: 'NYT Puzzle',
        digits,
        date,
        difficulty,
        source,
        filename,
    };
}

/**
 * Loads all NYT puzzles from pre-generated data
 * The data is generated by running: node scripts/generate-puzzle-data.js
 * @returns {Array} Array of puzzle objects sorted by date (newest first)
 */
export function loadNYTPuzzles() {
    try {
        // Import pre-generated puzzle data
        const { NYT_PUZZLES_DATA } = require('./nyt-puzzles-data');
        
        // Convert date strings back to Date objects
        const puzzles = NYT_PUZZLES_DATA.map(puzzle => ({
            ...puzzle,
            date: puzzle.date ? new Date(puzzle.date) : null,
        }));

        // Sort by date, newest first
        puzzles.sort((a, b) => {
            if (!a.date && !b.date) return 0;
            if (!a.date) return 1;
            if (!b.date) return -1;
            return b.date.getTime() - a.date.getTime();
        });

        return puzzles;
    } catch (error) {
        console.error('Failed to load NYT puzzles:', error);
        return [];
    }
}

/**
 * Maps difficulty levels to display names
 */
export const DIFFICULTY_DISPLAY_NAMES = {
    'easy': 'Easy',
    'medium': 'Medium',
    'hard': 'Hard',
    'expert': 'Expert',
};

/**
 * Maps difficulty levels to numeric values (for consistency with existing app)
 * 1 = Easy, 2 = Medium, 3 = Hard, 4 = Expert
 */
export const DIFFICULTY_TO_LEVEL = {
    'easy': '1',
    'medium': '2',
    'hard': '3',
    'expert': '4',
};
