#!/usr/bin/env node

/**
 * Generate NYT Puzzles Data Module
 * 
 * This script reads all .sdk files from nyt-scraper/sudoku and generates
 * a JavaScript module (nyt-puzzles-data.js) that exports the parsed puzzle data.
 * 
 * This avoids webpack configuration issues with loading raw text files.
 */

const fs = require('fs');
const path = require('path');

const SUDOKU_DIR = path.join(__dirname, '../nyt-scraper/sudoku');
const OUTPUT_FILE = path.join(__dirname, '../src/lib/nyt-puzzles-data.js');

/**
 * Parse a single .sdk file
 */
function parseSDKFile(content, filename) {
    const lines = content.split(/\r?\n/).filter(line => line.length > 0);
    
    if (lines.length < 11) {
        console.warn(`‚ö†Ô∏è  Skipping ${filename}: expected at least 11 lines, got ${lines.length}`);
        return null;
    }

    // Parse header
    const source = lines[0].startsWith('#S') ? lines[0].substring(2) : '';
    
    // Parse date (DD-MM-YYYY)
    let date = null;
    if (lines[1].startsWith('#B')) {
        const dateStr = lines[1].substring(2);
        const [day, month, year] = dateStr.split('-').map(s => parseInt(s, 10));
        date = new Date(year, month - 1, day);
    }

    // Extract difficulty from filename
    const filenameMatch = filename.match(/nyt-(\w+)-(\d{4}-\d{2}-\d{2})\.sdk$/);
    const difficulty = filenameMatch ? filenameMatch[1] : 'unknown';
    const dateFromFilename = filenameMatch ? filenameMatch[2] : filename.replace('.sdk', '');

    // Create unique puzzle ID
    const puzzleId = `nyt:${difficulty}-${dateFromFilename}`;

    // Parse puzzle data (lines 3-11)
    const puzzleLines = lines.slice(2, 11);
    const digits = puzzleLines
        .map(line => line.split('').map(char => char === '.' ? '0' : char).join(''))
        .join('');

    if (digits.length !== 81) {
        console.warn(`‚ö†Ô∏è  Skipping ${filename}: expected 81 characters, got ${digits.length}`);
        return null;
    }

    return {
        id: puzzleId,
        group: 'NYT Puzzle',
        digits,
        date: date ? date.toISOString() : null,
        difficulty,
        source,
        filename,
    };
}

/**
 * Main function
 */
function generatePuzzleData() {
    console.log('üîç Reading .sdk files from nyt-scraper/sudoku...');
    
    if (!fs.existsSync(SUDOKU_DIR)) {
        console.error(`‚ùå Directory not found: ${SUDOKU_DIR}`);
        process.exit(1);
    }

    const files = fs.readdirSync(SUDOKU_DIR).filter(f => f.endsWith('.sdk'));
    console.log(`üìÅ Found ${files.length} .sdk files`);

    const puzzles = [];
    let skipped = 0;

    files.forEach(filename => {
        const filePath = path.join(SUDOKU_DIR, filename);
        const content = fs.readFileSync(filePath, 'utf-8');
        const puzzle = parseSDKFile(content, filename);
        
        if (puzzle) {
            puzzles.push(puzzle);
        } else {
            skipped++;
        }
    });

    console.log(`‚úÖ Parsed ${puzzles.length} puzzles successfully`);
    if (skipped > 0) {
        console.log(`‚ö†Ô∏è  Skipped ${skipped} invalid files`);
    }

    // Generate JavaScript module
    const moduleContent = `/**
 * NYT Puzzles Data
 * 
 * This file is auto-generated by scripts/generate-puzzle-data.js
 * Do not edit manually!
 * 
 * Generated on: ${new Date().toISOString()}
 * Total puzzles: ${puzzles.length}
 */

export const NYT_PUZZLES_DATA = ${JSON.stringify(puzzles, null, 2)};
`;

    fs.writeFileSync(OUTPUT_FILE, moduleContent, 'utf-8');
    console.log(`üìù Generated ${OUTPUT_FILE}`);
    console.log('‚ú® Done!');
}

// Run the script
generatePuzzleData();
